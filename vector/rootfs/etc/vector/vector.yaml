# Vector Configuration for Home Assistant
# Documentation: https://vector.dev/docs/

# Data directory for Vector's disk buffers
data_dir: /data/vector

# API configuration (controlled by addon options)
api:
  enabled: true
  address: "0.0.0.0:8686"
  playground: true

# ============================================================================
# SOURCES - Where Vector collects data from
# ============================================================================
sources:
  # Home Assistant application logs
  homeassistant_logs:
    type: file
    include:
      - /config/home-assistant.log
    read_from: end

# ============================================================================
# TRANSFORMS - Process and enrich your data
# ============================================================================
transforms:
  # Parse Home Assistant log format
  parse_ha_logs:
    type: remap
    inputs:
      - homeassistant_logs
    source: |
      # Try to parse the Home Assistant log format
      parsed = parse_regex(.message, r'^(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d+) (?P<level>\w+) \((?P<source>[^)]+)\) \[(?P<component>[^\]]+)\] (?P<log_message>.*)$') ?? null
      
      if parsed != null {
        .dt = parsed.timestamp
        .level = downcase(parsed.level) ?? "info"
        .source = parsed.source
        .component = parsed.component
        .message = parsed.log_message
      } else {
        .level = "info"
      }
      
      # Add Home Assistant metadata
      .service = "home-assistant"
      .host = get_env_var("HOSTNAME") ?? "homeassistant"

  # Enrich with additional context
  enrich_logs:
    type: remap
    inputs:
      - parse_ha_logs
    source: |
      # Map log levels to Betterstack format
      .level = if .level == "warning" { "warn" } else { .level }
      
      # Add file info
      del(.file)
      del(.host)

# ============================================================================
# SINKS - Where Vector sends data
# ============================================================================
sinks:
  # Betterstack (Logtail) - Primary log destination
  betterstack:
    type: http
    inputs:
      - enrich_logs
    uri: "https://in.logs.betterstack.com"
    method: post
    encoding:
      codec: json
    auth:
      strategy: bearer
      token: "${BETTERSTACK_TOKEN}"
    buffer:
      type: memory
      max_events: 10000
      when_full: drop_newest
    batch:
      max_bytes: 1048576  # 1MB max batch
      timeout_secs: 5
    request:
      retry_attempts: 5
      retry_initial_backoff_secs: 1
      retry_max_duration_secs: 30
    healthcheck:
      enabled: false

  # Console output for local debugging (optional - can be disabled)
  console:
    type: console
    inputs:
      - enrich_logs
    encoding:
      codec: json
