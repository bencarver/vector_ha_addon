# Vector Configuration for Home Assistant
# Documentation: https://vector.dev/docs/

# Data directory for Vector's disk buffers
data_dir: /data/vector

# API configuration
api:
  enabled: true
  address: "0.0.0.0:8686"
  playground: true

# ============================================================================
# SOURCES - Where Vector collects data from
# ============================================================================
sources:
  # HTTP endpoint for receiving logs from Home Assistant
  http_logs:
    type: http_server
    address: "0.0.0.0:8687"
    encoding: json
    headers:
      - X-Log-Source
    strict_path: false
    path: /logs

# ============================================================================
# TRANSFORMS - Process and enrich your data
# ============================================================================
transforms:
  # Process incoming logs from Home Assistant
  process_ha_logs:
    type: remap
    inputs:
      - http_logs
    source: |
      # Set service identifier
      .service = "home-assistant"
      
      # Normalize level field
      .level = downcase(.level) ?? "info"
      .level = if .level == "warning" { "warn" } else { .level }
      
      # Ensure message exists
      .message = .message ?? .name ?? "No message"
      
      # Add timestamp if not present
      .dt = .timestamp ?? now()
      
      # Extract component from name if present
      if exists(.name) && !exists(.component) {
        .component = .name
      }
      
      # Clean up internal fields
      del(.path)
      del(.headers)
      del(.source_type)

# ============================================================================
# SINKS - Where Vector sends data
# ============================================================================
sinks:
  # Betterstack (Logtail) - Primary log destination
  betterstack:
    type: http
    inputs:
      - process_ha_logs
    uri: "https://in.logs.betterstack.com"
    method: post
    encoding:
      codec: json
    auth:
      strategy: bearer
      token: "${BETTERSTACK_TOKEN}"
    buffer:
      type: memory
      max_events: 10000
      when_full: drop_newest
    batch:
      max_bytes: 1048576
      timeout_secs: 5
    request:
      retry_attempts: 5
      retry_initial_backoff_secs: 1
      retry_max_duration_secs: 30
    healthcheck:
      enabled: false

  # Console output for debugging
  console:
    type: console
    inputs:
      - process_ha_logs
    encoding:
      codec: json
